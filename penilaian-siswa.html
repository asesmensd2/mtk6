<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Website Penilaian Siswa</title>
    <link href="https://fonts.googleapis.com/css?family=Poppins" rel="stylesheet" />
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Condensed:ital,wght@0,100..900;1,100..900" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" />
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: {
                        'poppins': ['Poppins', 'sans-serif'],
                        'condensed': ['"Roboto Condensed"', 'sans-serif'],
                    }
                }
            }
        }
    </script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
</head>
<body class="bg-gray-100 font-condensed">
    <div id="root"></div>
    <div id="fallback" class="text-center text-red-600 font-poppins">Jika halaman kosong, periksa konsol browser (Ctrl + Shift + I) untuk error.</div>
    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        function App() {
            const [data, setData] = useState([]);
            const [searchTerm, setSearchTerm] = useState('');
            const [sortBy, setSortBy] = useState('no');
            const [sortOrder, setSortOrder] = useState('asc');
            const [kkm, setKkm] = useState(50);
            const pieChartRef = useRef(null);
            const barChartRef = useRef(null);
            const tableContainerRef = useRef(null);
            const [pieChartInstance, setPieChartInstance] = useState(null);
            const [barChartInstance, setBarChartInstance] = useState(null);

            useEffect(() => {
                const savedData = JSON.parse(localStorage.getItem('allPesertaData')) || [];
                if (savedData.length > 0) {
                    setData(savedData);
                }
                updateDisplay();
            }, []);

            const handleFileUpload = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    const arrayBuffer = e.target.result;
                    const workbook = XLSX.read(arrayBuffer, { type: 'array' });
                    const sheetName = workbook.SheetNames[0];
                    const sheet = workbook.Sheets[sheetName];
                    const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1 });
                    const parsedData = jsonData.slice(1).map((row, index) => ({
                        no: row[0] || index + 1,
                        nama: row[1],
                        jawaban: row[2],
                        status: row[3],
                        scores: row.slice(4).map(val => parseInt(val) || 0),
                    })).filter(row => row.nama);
                    setData(parsedData);
                    localStorage.setItem('allPesertaData', JSON.stringify(parsedData));
                    updateDisplay();
                };
                reader.readAsArrayBuffer(file);
            };

            const numQuestions = data.length > 0 ? data[0].scores.length : 10; // Default 10 sesuai soal baru

            const calculateTotal = (scores) => scores.slice(0, numQuestions).reduce((a, b) => a + b, 0);

            const updateDisplay = () => {
                updateCharts();
                // Tidak perlu set ulang data, cukup trigger render ulang
            };

            const filteredData = data
                .filter(item => item.nama.toLowerCase().includes(searchTerm.toLowerCase()))
                .map(item => {
                    const totalBenar = calculateTotal(item.scores);
                    const nilaiAkhir = (totalBenar / numQuestions) * 100;
                    return {
                        ...item,
                        benar: totalBenar,
                        salah: numQuestions - totalBenar,
                        nilaiAkhir: nilaiAkhir,
                        isPassed: nilaiAkhir >= kkm // Tambah status lulus/tidak lulus
                    };
                });
            const sortedData = [...filteredData].sort((a, b) => {
                let compareA = sortBy === 'nama' ? a.nama.toLowerCase() : (sortBy === 'nilaiAkhir' ? a.nilaiAkhir : a.no);
                let compareB = sortBy === 'nama' ? b.nama.toLowerCase() : (sortBy === 'nilaiAkhir' ? b.nilaiAkhir : b.no);
                return sortOrder === 'asc' ? (compareA > compareB ? 1 : -1) : (compareA < compareB ? 1 : -1);
            });

            const handleSort = (key) => {
                if (sortBy === key) {
                    setSortOrder(sortOrder === 'asc' ? 'desc' : 'asc');
                } else {
                    setSortBy(key);
                    setSortOrder('asc');
                }
            };

            const exportToExcel = () => {
                const ws = XLSX.utils.json_to_sheet(sortedData.map(item => ({
                    No: item.no,
                    Nama: item.nama,
                    Jawaban: item.jawaban,
                    Status: item.status,
                    ...item.scores.slice(0, numQuestions).reduce((acc, score, idx) => ({ ...acc, [`${idx+1}`]: score }), {}),
                    B: item.benar,
                    S: item.salah,
                    'Nilai Akhir': item.nilaiAkhir.toFixed(2),
                    'Status Lulus': item.isPassed ? 'Lulus' : 'Tidak Lulus'
                })));
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, "Penilaian");
                XLSX.writeFile(wb, "penilaian_siswa.xlsx");
            };

            const exportToPDF = () => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                doc.text("Penilaian Siswa", 10, 10);
                let y = 20;
                sortedData.forEach(item => {
                    doc.text(`${item.no}. ${item.nama} - Nilai Akhir: ${item.nilaiAkhir.toFixed(2)} - ${item.isPassed ? 'Lulus' : 'Tidak Lulus'}`, 10, y);
                    y += 10;
                });
                doc.save("penilaian_siswa.pdf");
            };

            const updateCharts = () => {
                if (pieChartInstance) pieChartInstance.destroy();
                if (barChartInstance) barChartInstance.destroy();
                const totalStudents = data.length;
                const passed = data.filter(item => ((calculateTotal(item.scores) / numQuestions) * 100) >= kkm).length;
                const failed = totalStudents - passed;
                const pieCtx = pieChartRef.current.getContext('2d');
                const newPieChart = new Chart(pieCtx, {
                    type: 'pie',
                    data: {
                        labels: ['Lulus', 'Tidak Lulus'],
                        datasets: [{
                            data: [passed, failed],
                            backgroundColor: ['#4ade80', '#f87171'],
                            borderWidth: 2,
                            borderColor: '#ffffff'
                        }]
                    },
                    options: {
                        responsive: true,
                        animation: { animateScale: true, animateRotate: true, duration: 2000 },
                        plugins: { legend: { position: 'top', labels: { font: { size: 14 } } }, tooltip: { callbacks: { label: tooltipItem => `${tooltipItem.label}: ${tooltipItem.raw}` } } }
                    }
                });
                setPieChartInstance(newPieChart);
                const averages = Array(numQuestions).fill(0).map((_, i) =>
                    data.reduce((sum, item) => sum + (item.scores[i] || 0), 0) / totalStudents
                );
                const barColors = averages.map((_, i) => (i + 1) % 2 !== 0 ? '#10b981' : '#3b82f6');
                const barCtx = barChartRef.current.getContext('2d');
                const newBarChart = new Chart(barCtx, {
                    type: 'bar',
                    data: {
                        labels: Array.from({length: numQuestions}, (_, i) => `${i+1}`),
                        datasets: [{
                            label: 'Rata-rata Nilai',
                            data: averages,
                            backgroundColor: barColors,
                            borderWidth: 1,
                            borderColor: '#000000'
                        }]
                    },
                    options: {
                        responsive: true,
                        scales: { y: { beginAtZero: true, max: 1 } },
                        plugins: { legend: { display: false } }
                    }
                });
                setBarChartInstance(newBarChart);
            };

            const scrollLeft = () => tableContainerRef.current.scrollBy({ left: -200, behavior: 'smooth' });
            const scrollRight = () => tableContainerRef.current.scrollBy({ left: 200, behavior: 'smooth' });
            const handleKkmChange = (e) => {
                const value = parseFloat(e.target.value);
                if (value >= 0 && value <= 100) setKkm(value);
            };

            return (
                <div className="container mx-auto p-4">
                    <header className="text-center mb-8">
                        <h1 className="text-4xl font-bold text-gray-800 font-poppins">Website Penilaian Siswa</h1>
                        <p className="text-lg text-gray-600 font-condensed">Analisis Jawaban & Hasil Ujian</p>
                        <a href="ujian-selesai.html" className="text-blue-500 hover:underline font-poppins">
                            <i className="fas fa-arrow-left mr-2"></i>Kembali ke Ujian Selesai
                        </a>
                    </header>
                    <div className="mb-4 flex justify-between items-center">
                        <input
                            type="file"
                            accept=".csv, .xlsx"
                            onChange={handleFileUpload}
                            className="file:mr-4 file:py-2 file:px-4 file:rounded file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"
                        />
                        <input
                            type="text"
                            placeholder="Cari nama siswa..."
                            value={searchTerm}
                            onChange={e => setSearchTerm(e.target.value)}
                            className="p-2 border border-gray-300 rounded w-1/3"
                        />
                        <div className="flex items-center">
                            <label htmlFor="kkm" className="mr-2 text-gray-700">KKM:</label>
                            <input
                                id="kkm"
                                type="number"
                                min="0"
                                max="100"
                                value={kkm}
                                onChange={handleKkmChange}
                                className="p-2 border border-gray-300 rounded w-24 mr-2"
                            />
                            <button
                                onClick={updateDisplay}
                                className="bg-blue-500 text-white py-2 px-4 rounded hover:bg-blue-600"
                            >
                                Terapkan
                            </button>
                        </div>
                    </div>
                    <div className="mb-2 flex justify-between items-center">
                        <div>
                            <button onClick={exportToExcel} className="bg-green-500 text-white py-2 px-4 rounded mr-2 hover:bg-green-600">Export Excel</button>
                            <button onClick={exportToPDF} className="bg-red-500 text-white py-2 px-4 rounded hover:bg-red-600">Export PDF</button>
                        </div>
                        <div>
                            <button onClick={scrollLeft} className="bg-gray-300 text-gray-800 py-1 px-3 rounded mr-2 hover:bg-gray-400">&lt;</button>
                            <button onClick={scrollRight} className="bg-gray-300 text-gray-800 py-1 px-3 rounded hover:bg-gray-400">&gt;</button>
                        </div>
                    </div>
                    <div ref={tableContainerRef} className="overflow-x-auto bg-white shadow-md rounded-lg">
                        <table className="min-w-full table-auto divide-y divide-gray-400" style={{borderTop: '2px solid blue', borderBottom: '2px solid blue'}}>
                            <thead className="bg-gray-200">
                                <tr className="divide-x divide-gray-400">
                                    <th className="px-4 py-2 cursor-pointer" onClick={() => handleSort('no')}>No</th>
                                    <th className="px-4 py-2 cursor-pointer whitespace-nowrap" onClick={() => handleSort('nama')}>Nama Siswa {sortBy === 'nama' ? (sortOrder === 'asc' ? '↑' : '↓') : ''}</th>
                                    <th className="px-4 py-2">Rincian Jawaban</th>
                                    <th className="px-4 py-2">Status</th>
                                    {Array.from({length: numQuestions}, (_, i) => (
                                        <th key={i} className="px-4 py-2">{i+1}</th>
                                    ))}
                                    <th className="px-4 py-2">B</th>
                                    <th className="px-4 py-2">S</th>
                                    <th className="px-4 py-2 cursor-pointer" onClick={() => handleSort('nilaiAkhir')}>Nilai Akhir {sortBy === 'nilaiAkhir' ? (sortOrder === 'asc' ? '↑' : '↓') : ''}</th>
                                    <th className="px-4 py-2">Status Lulus</th> {/* Kolom baru */}
                                </tr>
                            </thead>
                            <tbody className="divide-y divide-gray-400">
                                {sortedData.map((item, index) => (
                                    <tr key={index} className="hover:bg-gray-100 divide-x divide-gray-400">
                                        <td className="border-0 px-4 py-1">{item.no}</td>
                                        <td className="border-0 px-4 py-1 whitespace-nowrap">{item.nama}</td>
                                        <td className="border-0 px-4 py-1 font-mono text-sm">{item.jawaban}</td>
                                        <td className="border-0 px-4 py-1">{item.status}</td>
                                        {item.scores.slice(0, numQuestions).map((score, i) => (
                                            <td key={i} className={`border-0 px-4 py-1 text-center ${score === 1 ? 'bg-green-200' : 'bg-red-200'}`}>
                                                {score}
                                            </td>
                                        ))}
                                        <td className="border-0 px-4 py-1 text-center">{item.benar}</td>
                                        <td className="border-0 px-4 py-1 text-center">{item.salah}</td>
                                        <td className="border-0 px-4 py-1 text-center">{item.nilaiAkhir.toFixed(2)}</td>
                                        <td className={`border-0 px-4 py-1 text-center ${item.isPassed ? 'text-green-600 font-bold' : 'text-red-600 font-bold'}`}>
                                            {item.isPassed ? 'Lulus' : 'Tidak Lulus'}
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>
                    <div className="mt-8">
                        <div>
                            <h2 className="text-2xl font-bold mb-4 font-poppins">Ringkasan Lulus/Tidak Lulus</h2>
                            <div className="max-w-xs mx-auto">
                                <canvas ref={pieChartRef} className="h-48"></canvas>
                            </div>
                        </div>
                    </div>
                    <div className="mt-8">
                        <div>
                            <h2 className="text-2xl font-bold mb-4 font-poppins">Rata-rata Nilai per Soal</h2>
                            <div className="max-w-2xl mx-auto">
                                <canvas ref={barChartRef} className="h-48"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        document.getElementById('fallback').style.display = 'none';
        ReactDOM.render(<App />, document.getElementById('root'));
    </script>
</body>
</html>